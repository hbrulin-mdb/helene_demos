# Show the machines
Explain that for prod deployments, it is recommended to deploy ops manager on at least 3 servers + Load balancer
Explain the components : ops manager, app db.

Explain the appdb is different than the cluster. The ops manager application handles all communication with the mdb cluster.  So we need to place an automation agent on every host running mongodb cluster.

Need one agent per host. 

# Créer un replica set via l'UI
https://www.mongodb.com/docs/ops-manager/current/tutorial/deploy-replica-set/
- use default directories
- change the hostnames 
- show possibility to change the member type, the votes, the priority, the tags (for read preference)
- explain the replication settings options
- read and write concerns

# Créer un replica set via l'API
I have created my workspace for Postman and put the necessary API info : [Link to my Postman workspace](https://helene-brulin-5394823.postman.co/workspace/Helene-Brulin's-Workspace~ec31a60f-89a9-47cd-8850-45379e0d1ed0/request/50768343-5baa8867-8057-4e7c-ac20-9f338c98b355?action=share&creator=50768343)

In variables : 
- url : http://ec2-35-180-43-241.eu-west-3.compute.amazonaws.com:8080/
- project ID : b69410d9f9bee61613699e211

Use the Global Programmatic API Key (in Admin), not an API Key defined in the nonAdmin UI!!

Steps : 
- Run GetAutomationConfig call
- Copy the output in a json file
- Find the processes array and update the processes -> see automation_config.json
- Find the top level replicasetArray and add the replicaset -> see automation_config.json

Then use the PUT query, with raw json as the body.
(If I get a 403 error with Ressource Requires Access List, go add my current IP in Admin - General - Global Access List)
 
## API calls
- GET http://ec2-35-180-43-241.eu-west-3.compute.amazonaws.com:8080/api/public/v1.0/groups/b69410d9f9bee61613699e211/automationConfig?pretty=true
- PUT : http://ec2-35-180-43-241.eu-west-3.compute.amazonaws.com:8080/api/public/v1.0/groups/69410d9f9bee61613699e211/automationConfig

# Monitoring

## Go the metrics, real-time panel, etc...

## If AppDB monitoring is enabled -> go check the metrics for AppDB. 

# Backup
Use the amadeus-pitr demo. 

# encryption at Rest

Ops Manager can enable encryption at rest for:
- MongoDB deployments it manages (replica sets and sharded clusters)
- The Ops Manager Application Database (appdb), if you choose to manage it via Automation
- Backup components (the Oplog Store, and the Blockstore/Snapshot Store)

Prereq : A KMIP-compatible KMS reachable from all database hosts (examples: Thales/Gemalto, HashiCorp Vault KMIP, Entrust). Ensure network access, mutual TLS certificates, and firewall rules.

## For the cluster : 
- https://www.mongodb.com/docs/manual/tutorial/configure-encryption/ 
- MongoDB cannot encrypt existing data : You must have no existing data (or perform a rolling initial sync if data exists) because enabling encryption at rest requires starting with no pre-existing unencrypted data.
Ops Manager doesn’t provide a UI switch specifically labeled “encrypt data at rest” in the deployment screens — instead, encryption is enabled via the underlying MongoDB configuration that Ops Manager manages.

You need to inject the following into each mongod process configuration so that Ops Manager will start MongoDB with encryption enabled:

```sh
security:
  enableEncryption: true
  kmip:
    serverName: "kms.example.com"
    port: 5696
    serverCAFile: "/path/to/ca.pem"
    clientCertificateFile: "/path/to/client.pem"
    # optionally keyIdentifier if using a specific key
  ```

This enables encrypted storage at the WiredTiger level and directs mongod to talk to your KMIP server.

You can update the cluster config:
- Go to Deployment > Processes
- For each mongod process: Click Modify
- Go to Advanced Configuration Options
- Add the security.enableEncryption: true and the KMIP block shown above (one by one)
- Save and deploy changes

Ops Manager will update the automation config to include the encryption settings and restart the processes accordingly.


## For Backups : 
- Admin - General - Ops Manager Config - Backup

## For Audit Logs : 
- https://www.mongodb.com/docs/manual/core/security-encryption-at-rest/#audit-log


# Se connecter avec compass
mongodb://ec2-13-38-10-142.eu-west-3.compute.amazonaws.com:27017 -> url of the primary
-> this is without password, authent, TLS...

or with IPs : mongodb://15.188.15.59:27017



### Check the AppDB oplog
Install mongosh on Ops manager machine

```sh
wget https://downloads.mongodb.com/compass/mongosh-2.5.10-linux-x64.tgz
tar -xvf mongosh-2.5.10-linux-x64.tgz
cd mongosh-2.5.10-linux-x64/
chmod +x bin/mongosh
bin/mongosh
show dbs
use backupoplogs
show collections
```

